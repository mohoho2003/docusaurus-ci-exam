name: Build and Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.0'

      - name: Install dependencies
        working-directory: ./my-website
        run: npm ci

      - name: Build
        working-directory: ./my-website
        run: npm run build

      - name: Tester le build
        working-directory: ./my-website
        run: |
          # Vérifier que le dossier build existe
          if [ ! -d "build" ]; then
            echo "rreur: Dossier build manquant"
            exit 1
          fi
          
          # Vérifier les fichiers essentiels
          required_files=(
            "build/index.html"
            "build/docs/initialisation/index.html"
            "build/docs/ci-github-actions/index.html"
            "build/docs/deploiement/index.html"
            "build/docs/tests/index.html"
            "build/docs/linting/index.html"
            "build/docs/git-shitflow/index.html"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "erreur: $file manquant"
              exit 1
            fi
            if [ ! -s "$file" ]; then
              echo "erreur: $file est vide"
              exit 1
            fi
          done
          
          echo "Tous les fichiers sont présents et non-vides"

      - name: Create version.txt
        working-directory: ./my-website
        run: |
          echo "Version: 1.0.${{ github.run_number }}" > build/version.txt
          echo "Date: $(date)" >> build/version.txt
          echo "Commit: ${{ github.sha }}" >> build/version.txt
          echo "" >> build/version.txt
          echo "Made by me" >> build/version.txt

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./my-website/dist

# Made by me